@page "/customers/promote"
@using Microsoft.EntityFrameworkCore
@using SpaAndBeautyWebsite.Models
@inject IDbContextFactory<SpaAndBeautyWebsite.Data.SpaAndBeautyWebsiteContext> DbFactory
@inject NavigationManager NavigationManager
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = "RequireAdmin")]
@rendermode InteractiveServer

<PageTitle>Promote</PageTitle>

<h1>Promote Customer to Employee</h1>

@if (Customer is null)
{
    <p><em>Loading...</em></p>
}
else
{
    <h2>Promote: @Customer.FirstName @Customer.LastName</h2>
    <hr />
    <div class="row">
        <div class="col-md-6">
            <EditForm Model="Employee" OnValidSubmit="PromoteCustomer" OnInvalidSubmit="HandleInvalidSubmit">
                <DataAnnotationsValidator />
                <ValidationSummary class="text-danger" role="alert" />

                <input type="hidden" value="@Customer.CustomerId" />

                <div class="mb-3">
                    <label for="firstname" class="form-label">FirstName:</label>
                    <InputText id="firstname" @bind-Value="Employee.FirstName" class="form-control" />
                    <ValidationMessage For="() => Employee.FirstName" class="text-danger" />
                </div>

                <div class="mb-3">
                    <label for="lastname" class="form-label">LastName:</label>
                    <InputText id="lastname" @bind-Value="Employee.LastName" class="form-control" />
                    <ValidationMessage For="() => Employee.LastName" class="text-danger" />
                </div>

                <div class="mb-3">
                    <label for="username" class="form-label">Username:</label>
                    <InputText id="username" @bind-Value="Employee.Username" class="form-control" />
                    <ValidationMessage For="() => Employee.Username" class="text-danger" />
                </div>

                <div class="mb-3">
                    <label for="password" class="form-label">Password:</label>
                    <InputText id="password" type="password" @bind-Value="Employee.Password" class="form-control" />
                    <ValidationMessage For="() => Employee.Password" class="text-danger" />
                </div>

                <div class="mb-3">
                    <label for="phonenumber" class="form-label">PhoneNumber:</label>
                    <InputText id="phonenumber" @bind-Value="Employee.PhoneNumber" class="form-control"
                               placeholder="123-456-7890 or +1-123-456-7890" />
                    <ValidationMessage For="() => Employee.PhoneNumber" class="text-danger" />
                </div>

                <div class="mb-3">
                    <label for="email" class="form-label">Email:</label>
                    <InputText id="email" @bind-Value="Employee.Email" class="form-control" />
                    <ValidationMessage For="() => Employee.Email" class="text-danger" />
                </div>

                <div class="mb-3">
                    <label for="street" class="form-label">Street:</label>
                    <InputText id="street" @bind-Value="Employee.Street" class="form-control" />
                    <ValidationMessage For="() => Employee.Street" class="text-danger" />
                </div>

                <div class="mb-3">
                    <label for="city" class="form-label">City:</label>
                    <InputText id="city" @bind-Value="Employee.City" class="form-control" />
                    <ValidationMessage For="() => Employee.City" class="text-danger" />
                </div>

                <div class="mb-3">
                    <label for="state" class="form-label">State:</label>
                    <InputSelect id="state" @bind-Value="Employee.State" class="form-control">
                        <option value="">-- select state --</option>
                        @foreach (var s in States)
                        {
                            <option value="@s">@s</option>
                        }
                    </InputSelect>
                    <ValidationMessage For="() => Employee.State" class="text-danger" />
                </div>

                <div class="mb-3">
                    <label for="zipcode" class="form-label">ZipCode:</label>
                    <InputText id="zipcode" @bind-Value="Employee.ZipCode" class="form-control"
                               placeholder="12345 or 12345-6789" />
                    <ValidationMessage For="() => Employee.ZipCode" class="text-danger" />
                </div>

                <div class="mb-3">
                    <label for="jobtitle" class="form-label">JobTitle:</label>
                    <InputText id="jobtitle" @bind-Value="Employee.JobTitle" class="form-control" />
                    <ValidationMessage For="() => Employee.JobTitle" class="text-danger" />
                </div>

                <div class="mb-3">
                    <label for="salary" class="form-label">Salary:</label>
                    <InputNumber id="salary" @bind-Value="Employee.Salary" class="form-control" />
                    <ValidationMessage For="() => Employee.Salary" class="text-danger" />
                </div>

                <div class="mb-3">
                    <label for="permission" class="form-label">Permission:</label>
                    <InputSelect id="permission" @bind-Value="Employee.Permission" class="form-control">
                        <option value="">-- select permission --</option>
                        <option value="Admin">Admin</option>
                        <option value="Staff">Staff</option>
                        <option value="Manager">Manager</option>
                    </InputSelect>
                    <ValidationMessage For="() => Employee.Permission" class="text-danger" />
                </div>

                <button type="submit" class="btn btn-primary">Promote</button>
                <a class="btn btn-secondary ms-2" href="/edit-users">Cancel</a>
            </EditForm>
        </div>
    </div>
}

@code {
    [SupplyParameterFromQuery]
    private int CustomerId { get; set; }

    private Customer? Customer { get; set; }

    private Employee Employee { get; set; } = new()
    {
        FirstName = string.Empty,
        LastName = string.Empty,
        PhoneNumber = string.Empty,
        Email = string.Empty,
        Password = string.Empty,
        Street = string.Empty,
        City = string.Empty,
        State = string.Empty,
        ZipCode = string.Empty,
        JobTitle = string.Empty,
        Permission = string.Empty,
        Username = string.Empty,
        Salary = 0m
    };

    private readonly string[] States = new[]
    {
        "Alabama","Alaska","Arizona","Arkansas","California","Colorado","Connecticut","Delaware",
        "Florida","Georgia","Hawaii","Idaho","Illinois","Indiana","Iowa","Kansas","Kentucky","Louisiana",
        "Maine","Maryland","Massachusetts","Michigan","Minnesota","Mississippi","Missouri","Montana",
        "Nebraska","Nevada","New Hampshire","New Jersey","New Mexico","New York","North Carolina",
        "North Dakota","Ohio","Oklahoma","Oregon","Pennsylvania","Rhode Island","South Carolina",
        "South Dakota","Tennessee","Texas","Utah","Vermont","Virginia","Washington","West Virginia",
        "Wisconsin","Wyoming"
    };

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        Customer = await context.Customer.FirstOrDefaultAsync(c => c.CustomerId == CustomerId);

        if (Customer is null)
        {
            NavigationManager.NavigateTo("notfound");
            return;
        }

        // Autofill known fields from the customer into the employee model.
        Employee.FirstName = Customer.FirstName;
        Employee.LastName = Customer.LastName;
        Employee.Username = Customer.Username;
        Employee.Password = Customer.Password;
        Employee.PhoneNumber = Customer.PhoneNumber;
        Employee.Email = Customer.Email;

        // If the Customer has address fields on its model and you want to copy them,
        // do so here (I've left them empty by default so user confirms).
        Employee.Street = string.Empty;
        Employee.City = string.Empty;
        Employee.State = string.Empty;
        Employee.ZipCode = string.Empty;

        // Prefer an allowed permission value so validation can pass quickly
        if (string.IsNullOrWhiteSpace(Employee.Permission))
        {
            Employee.Permission = "Staff";
        }
    }

    private async Task PromoteCustomer()
    {
        using var context = DbFactory.CreateDbContext();

        // Ensure the customer still exists in this context
        var customerInDb = await context.Customer.FirstOrDefaultAsync(c => c.CustomerId == CustomerId);
        if (customerInDb is null)
        {
            NavigationManager.NavigateTo("notfound");
            return;
        }

        // Add the new employee
        context.Employee.Add(Employee);

        // Remove the customer record
        context.Customer.Remove(customerInDb);

        try
        {
            await context.SaveChangesAsync();
        }
        catch (DbUpdateException)
        {
            // handle unique constraint or other DB errors here if needed
            throw;
        }

        NavigationManager.NavigateTo("/edit-users");
    }

    private void HandleInvalidSubmit(EditContext editContext)
    {
        // Force UI update so ValidationSummary/ValidationMessage show errors.
        StateHasChanged();
    }
}
