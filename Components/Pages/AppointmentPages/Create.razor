@page "/appointments/create"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Authorization
@using SpaAndBeautyWebsite.Models
@using SpaAndBeautyWebsite.Data
@inject IDbContextFactory<SpaAndBeautyWebsite.Data.SpaAndBeautyWebsiteContext> DbFactory
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Create Appointment</PageTitle>

<h1>Create Appointment</h1>
<hr />

<div class="row">
    <div class="col-md-4">
        <EditForm Model="Appointment" OnValidSubmit="AddAppointment" FormName="create">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" role="alert" />

            @if (IsAdminOrEmployee)
            {
                <div class="mb-3">
                    <label for="customerid" class="form-label">Customer (Admin/Employee View):</label>
                    <InputSelect id="customerid" @bind-Value="Appointment.CustomerId" class="form-control">
                        <option value="0">-- Select Customer --</option>
                        @foreach (var customer in CustomersList)
                        {
                            <option value="@customer.CustomerId">@customer.FirstName @customer.LastName (@customer.Username)</option>
                        }
                    </InputSelect>
                </div>
            }

            <div class="mb-3">
                <label for="scheduleddate" class="form-label">Date:</label>
                <InputDate id="scheduleddate"
                           Value="SelectedDate"
                           ValueChanged="@(async (DateTime value) => { SelectedDate = value; await LoadAvailableTimesAsync(); })"
                           ValueExpression="@(() => SelectedDate)"
                           class="form-control" />
            </div>

            <div class="mb-3">
                <label for="employeeid" class="form-label">Employee:</label>
                <InputSelect id="employeeid"
                             TValue="int"
                             Value="SelectedEmployeeId"
                             ValueChanged="@(async (int value) => { SelectedEmployeeId = value; await LoadAvailableTimesAsync(); })"
                             ValueExpression="@(() => SelectedEmployeeId)"
                             class="form-control">
                    <option value="0">-- Select Employee --</option>
                    @foreach (var employee in Employees)
                    {
                        <option value="@employee.EmployeeId">@employee.FirstName @employee.LastName</option>
                    }
                </InputSelect>
            </div>

            <div class="mb-3">
                <label for="serviceid" class="form-label">Service:</label>
                <InputSelect id="serviceid"
                             TValue="int"
                             Value="SelectedServiceId"
                             ValueChanged="@(async (int value) => { SelectedServiceId = value; await LoadAvailableTimesAsync(); })"
                             ValueExpression="@(() => SelectedServiceId)"
                             class="form-control">
                    <option value="0">-- Select Service --</option>
                    @foreach (var service in Services)
                    {
                        <option value="@service.ServiceId">@service.Name</option>
                    }
                </InputSelect>
            </div>

            @if (SelectedService != null)
            {
                <div class="mb-3">
                    <label class="form-label">Duration (minutes):</label>
                    <input class="form-control" value="@SelectedService.DurationMinutes" readonly />
                </div>
            }

            @if (AvailableTimes.Any())
            {
                <div class="mb-3">
                    <label for="scheduledtime" class="form-label">Time:</label>
                    <InputSelect id="scheduledtime" @bind-Value="SelectedTime" class="form-control">
                        <option value="">-- Select Time --</option>
                        @foreach (var time in AvailableTimes)
                        {
                            <option value="@time">@DateTime.Today.Add(time).ToString("hh:mm tt")</option>
                        }
                    </InputSelect>
                </div>
            }
            else if (SelectedEmployeeId > 0 && SelectedServiceId > 0)
            {
                <div class="mb-3">
                    <p class="text-info">No available times for the selected date.</p>
                </div>
            }

            <button type="submit" class="btn btn-primary" disabled="@(!SelectedTime.HasValue)">
                Create Appointment
            </button>
        </EditForm>
    </div>
</div>

<div class="mt-3">
    <a href="/appointments">Back to List</a>
</div>

@code {
    [SupplyParameterFromForm]
    private Appointment Appointment { get; set; } = new() { Status = "Scheduled" };

    private List<Employee> Employees { get; set; } = new();
    private List<Service> Services { get; set; } = new();
    private List<Customer> CustomersList { get; set; } = new(); // For Admin selection
    private List<TimeSpan> AvailableTimes { get; set; } = new();
    private DateTime SelectedDate { get; set; } = DateTime.Today;
    private int SelectedEmployeeId { get; set; }
    private int SelectedServiceId { get; set; }
    private TimeSpan? SelectedTime { get; set; }

    // Auth Variables
    private int? LoggedInCustomerId;
    private bool IsAdminOrEmployee = false;

    private Service? SelectedService => Services.FirstOrDefault(s => s.ServiceId == SelectedServiceId);

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();

        // 1. Determine who is logged in
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var username = user.Identity?.Name ?? "";

        if (user.IsInRole("Customer"))
        {
            // Find the Customer ID for the logged-in user
            var currentCustomer = await context.Customer
                .FirstOrDefaultAsync(c => c.Username == username);

            if (currentCustomer != null)
            {
                LoggedInCustomerId = currentCustomer.CustomerId;
            }
        }
        else if (user.IsInRole("Employee") || user.IsInRole("Admin"))
        {
            IsAdminOrEmployee = true;
            // Employees need to be able to select a customer from a list
            CustomersList = await context.Customer.OrderBy(c => c.LastName).ToListAsync();
        }

        // 2. Load form data
        Employees = await context.Employee
            .OrderBy(e => e.FirstName)
            .ThenBy(e => e.LastName)
            .ToListAsync();

        Services = await context.Service
            .OrderBy(s => s.Name)
            .ToListAsync();
    }

    private async Task LoadAvailableTimesAsync()
    {
        AvailableTimes.Clear();
        SelectedTime = null;

        if (SelectedEmployeeId <= 0 || SelectedServiceId <= 0 || SelectedService == null)
        {
            return;
        }

        Appointment.EmployeeId = SelectedEmployeeId;
        Appointment.ServiceId = SelectedServiceId;
        Appointment.DurationMinutes = SelectedService.DurationMinutes;

        var duration = SelectedService.DurationMinutes;
        var start = new TimeSpan(9, 0, 0);
        var end = new TimeSpan(17, 0, 0);

        var allSlots = new List<TimeSpan>();
        for (var time = start; time.Add(TimeSpan.FromMinutes(duration)) <= end; time = time.Add(TimeSpan.FromMinutes(30)))
        {
            allSlots.Add(time);
        }

        using var context = DbFactory.CreateDbContext();
        var existingAppointments = await context.Appointment
            .Where(a => a.EmployeeId == SelectedEmployeeId && a.ScheduledDateTime.Date == SelectedDate.Date)
            .ToListAsync();

        AvailableTimes = allSlots.Where(slot =>
        {
            var slotEnd = slot.Add(TimeSpan.FromMinutes(duration));
            return !existingAppointments.Any(appt =>
            {
                var apptStart = appt.ScheduledDateTime.TimeOfDay;
                var apptEnd = apptStart.Add(TimeSpan.FromMinutes(appt.DurationMinutes));
                return slot < apptEnd && slotEnd > apptStart;
            });
        }).ToList();

        StateHasChanged();
    }

    private async Task AddAppointment()
    {
        if (!SelectedTime.HasValue || SelectedService == null)
            return;

        // FINAL CHECK: Assign the Customer ID
        if (IsAdminOrEmployee)
        {
            // The value is bound to Appointment.CustomerId from the dropdown
            if (Appointment.CustomerId == 0)
            {
                // Error: Employee didn't select a customer
                return;
            }
        }
        else if (LoggedInCustomerId.HasValue)
        {
            // Auto-assign the logged-in Customer's ID
            Appointment.CustomerId = LoggedInCustomerId.Value;
        }

        Appointment.ScheduledDateTime = SelectedDate.Date.Add(SelectedTime.Value);
        Appointment.EmployeeId = SelectedEmployeeId;
        Appointment.ServiceId = SelectedServiceId;
        Appointment.DurationMinutes = SelectedService.DurationMinutes;
        Appointment.Status = "Scheduled";

        using var context = DbFactory.CreateDbContext();
        context.Appointment.Add(Appointment);
        await context.SaveChangesAsync();

        NavigationManager.NavigateTo("/appointments");
    }
}