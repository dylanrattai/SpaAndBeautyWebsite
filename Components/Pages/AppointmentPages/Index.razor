@page "/appointments"
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.QuickGrid
@using SpaAndBeautyWebsite.Models
@using SpaAndBeautyWebsite.Data
@implements IAsyncDisposable
@inject IDbContextFactory<SpaAndBeautyWebsite.Data.SpaAndBeautyWebsiteContext> DbFactory

<PageTitle>Index</PageTitle>

<h1>Index</h1>

<p>
    <a href="appointments/create">Create New</a>
</p>

@* We bind to 'items', which allows us to show "Unknown" instead of hiding the row *@
<QuickGrid Class="table" Items="items">

    <PropertyColumn Property="@(p => p.EmployeeName)" Title="Employee" Sortable="true" />
    <PropertyColumn Property="@(p => p.CustomerName)" Title="Customer" Sortable="true" />
    <PropertyColumn Property="@(p => p.ServiceName)" Title="Service" Sortable="true" />

    <PropertyColumn Property="@(p => p.ScheduledDateTime)" Title="Scheduled Date" Format="g" Sortable="true" />
    <PropertyColumn Property="@(p => p.DurationMinutes)" Title="Duration" Sortable="true" />
    <PropertyColumn Property="@(p => p.Status)" Title="Status" Sortable="true" />

    <TemplateColumn Context="p">
        @* Note: We use p.AppointmentId here because 'p' is our custom ViewModel *@
        <a href="@($"appointments/edit?appointmentid={p.AppointmentId}")">Edit</a> |
        <a href="@($"appointments/details?appointmentid={p.AppointmentId}")">Details</a> |
        <a href="@($"appointments/delete?appointmentid={p.AppointmentId}")">Delete</a>
    </TemplateColumn>
</QuickGrid>

@code {
    private SpaAndBeautyWebsiteContext context = default!;

    // Use IQueryable of our custom class so QuickGrid can sort/filter automatically
    private IQueryable<AppointmentViewModel> items = default!;

    public class AppointmentViewModel
    {
        public int AppointmentId { get; set; }
        public string EmployeeName { get; set; } = "";
        public string CustomerName { get; set; } = "";
        public string ServiceName { get; set; } = "";
        public DateTime ScheduledDateTime { get; set; }
        public int DurationMinutes { get; set; }
        public string? Status { get; set; }
    }

    protected override void OnInitialized()
    {
        context = DbFactory.CreateDbContext();

        // THIS IS THE FIX: Using "Left Joins" (DefaultIfEmpty)
        // This ensures the appointment shows up even if IDs are 0 or invalid.

        items = from a in context.Appointment

                    // Join Employee (Safe)
                join e in context.Employee on a.EmployeeId equals e.EmployeeId into eGroup
                from e in eGroup.DefaultIfEmpty()

                    // Join Customer (Safe)
                join c in context.Customer on a.CustomerId equals c.CustomerId into cGroup
                from c in cGroup.DefaultIfEmpty()

                    // Join Service (Safe)
                join s in context.Service on a.ServiceId equals s.ServiceId into sGroup
                from s in sGroup.DefaultIfEmpty()

                select new AppointmentViewModel
                {
                    AppointmentId = a.AppointmentId,
                    // If 'e' is null (no match), use "Unknown"
                    EmployeeName = e != null ? e.FirstName + " " + e.LastName : "Unknown Employee",

                    // If 'c' is null (no match), use "Unknown"
                    CustomerName = c != null ? c.FirstName + " " + c.LastName : "Unknown Customer",

                    // If 's' is null (no match), use "Unknown"
                    ServiceName = s != null ? s.Name : "Unknown Service",

                    ScheduledDateTime = a.ScheduledDateTime,
                    DurationMinutes = a.DurationMinutes,
                    Status = a.Status
                };
    }

    public async ValueTask DisposeAsync() => await context.DisposeAsync();
}
