@page "/appointments"
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.QuickGrid
@using SpaAndBeautyWebsite.Models
@using SpaAndBeautyWebsite.Data
@implements IAsyncDisposable
@inject IDbContextFactory<SpaAndBeautyWebsite.Data.SpaAndBeautyWebsiteContext> DbFactory

<PageTitle>Index</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Appointments</h1>
    <a href="appointments/create" class="btn btn-primary">
        <i class="bi bi-plus-lg"></i> Create New
    </a>
</div>

<QuickGrid Class="table table-striped table-hover table-bordered align-middle"
           Items="items"
           RowClass="@GetRowClass">

    <PropertyColumn Property="@(p => p.EmployeeName)" Title="Employee" Sortable="true" />
    <PropertyColumn Property="@(p => p.CustomerName)" Title="Customer" Sortable="true" />
    <PropertyColumn Property="@(p => p.ServiceName)" Title="Service" Sortable="true" />
    <PropertyColumn Property="@(p => p.ScheduledDateTime)" Title="Date & Time" Format="g" Sortable="true" />
    <PropertyColumn Property="@(p => p.DurationMinutes)" Title="Duration (m)" Sortable="true" Class="text-center" />

    <TemplateColumn Title="Status" Sortable="true">
        @switch (context.Status)
        {
            case "Completed":
                <span class="badge bg-success">Completed</span>
                break;
            case "No Show":
                <span class="badge bg-danger">No Show</span>
                break;
            case "Checked In":
                <span class="badge bg-info text-dark">Checked In</span>
                break;
            case "In Progress":
                <span class="badge bg-warning text-dark">In Progress</span>
                break;
            default:
                <span class="badge bg-primary">@context.Status</span>
                break;
        }
    </TemplateColumn>

    <TemplateColumn Title="Actions">
        <div class="d-flex gap-2">
            @if (context.Status != "Completed" && context.Status != "No Show" && context.Status != "Cancelled")
            {
                <a href="@($"appointments/edit?appointmentid={context.AppointmentId}")" class="btn btn-sm btn-outline-primary">
                    Edit
                </a>
                <a href="@($"appointments/delete?appointmentid={context.AppointmentId}")" class="btn btn-sm btn-outline-danger">
                    Delete
                </a>
            }
        </div>
    </TemplateColumn>

</QuickGrid>

@code {
    private SpaAndBeautyWebsiteContext context = default!;
    private IQueryable<AppointmentViewModel> items = default!;

    private string GetRowClass(AppointmentViewModel appointment)
    {
        if (appointment.Status == "Completed" || appointment.Status == "No Show" || appointment.Status == "Cancelled")
        {
            return "row-inactive";
        }
        return "";
    }

    public class AppointmentViewModel
    {
        public int AppointmentId { get; set; }
        public string EmployeeName { get; set; } = "";
        public string CustomerName { get; set; } = "";
        public string ServiceName { get; set; } = "";
        public DateTime ScheduledDateTime { get; set; }
        public int DurationMinutes { get; set; }
        public string? Status { get; set; }
    }

    protected override void OnInitialized()
    {
        context = DbFactory.CreateDbContext();

        var query = from a in context.Appointment
            join e in context.Employee on a.EmployeeId equals e.EmployeeId into eGroup
            from e in eGroup.DefaultIfEmpty()
            join c in context.Customer on a.CustomerId equals c.CustomerId into cGroup
            from c in cGroup.DefaultIfEmpty()
            join s in context.Service on a.ServiceId equals s.ServiceId into sGroup
            from s in sGroup.DefaultIfEmpty()
            select new AppointmentViewModel
            {
                AppointmentId = a.AppointmentId,
                EmployeeName = e != null ? e.FirstName + " " + e.LastName : "Unknown Employee",
                CustomerName = c != null ? c.FirstName + " " + c.LastName : "Unknown Customer",
                ServiceName = s != null ? s.Name : "Unknown Service",
                ScheduledDateTime = a.ScheduledDateTime,
                DurationMinutes = a.DurationMinutes,
                Status = a.Status
            };

        // Apply the Custom Sort:
        // 1. Sort by Status using your specific weighting
        // 2. Then sort by Date & Time for items within the same status
        items = query
            .OrderBy(x => x.Status == "Scheduled" ? 1 :
                x.Status == "Checked In" ? 2 :
                x.Status == "In Progress" ? 3 :
                x.Status == "Completed" ? 4 :
                5) // Rank 5 covers "No Show", "Cancelled", etc.
            .ThenBy(x => x.ScheduledDateTime);
    }

    public async ValueTask DisposeAsync() => await context.DisposeAsync();
}
