@page "/reviews/create"
@using Microsoft.EntityFrameworkCore
@using SpaAndBeautyWebsite.Models
@inject IDbContextFactory<SpaAndBeautyWebsite.Data.SpaAndBeautyWebsiteContext> DbFactory
@inject NavigationManager NavigationManager

<PageTitle>Write a Review</PageTitle>

<div class="row justify-content-center">
    <div class="col-md-8">
        <h1 class="text-center section-title">Write a Review</h1>
        <div class="title-divider"></div>

        <EditForm method="post" Model="Review" OnValidSubmit="AddReview" FormName="create" Enhance>
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" role="alert" />

            <div class="mb-3">
                <label for="customer" class="form-label">Who are you?</label>
                <InputSelect id="customer" @bind-Value="Review.CustomerId" class="form-control">
                    <option value="">-- Select Your Name --</option>
                    @foreach (var c in Customers)
                    {
                        <option value="@c.CustomerId">@c.FirstName @c.LastName</option>
                    }
                </InputSelect>
                <ValidationMessage For="() => Review.CustomerId" class="text-danger" />
            </div>

            <div class="mb-3">
                <label for="service" class="form-label">Service Received:</label>
                <InputSelect id="service" @bind-Value="Review.ServiceId" class="form-control">
                    <option value="">-- Select Service --</option>
                    @foreach (var s in Services)
                    {
                        <option value="@s.ServiceId">@s.Name</option>
                    }
                </InputSelect>
                <ValidationMessage For="() => Review.ServiceId" class="text-danger" />
            </div>

            <div class="mb-3">
                <label for="employee" class="form-label">Employee seen:</label>
                <InputSelect id="employee" @bind-Value="Review.EmployeeId" class="form-control">
                    <option value="">-- Select Employee --</option>
                    @foreach (var e in Employees)
                    {
                        <option value="@e.EmployeeId">@e.FirstName @e.LastName</option>
                    }
                </InputSelect>
                <ValidationMessage For="() => Review.EmployeeId" class="text-danger" />
            </div>

            <div class="mb-3">
                <label for="rating" class="form-label">Rating (1-10):</label>
                <InputNumber id="rating" @bind-Value="Review.Rating" class="form-control" />
                <ValidationMessage For="() => Review.Rating" class="text-danger" />
            </div>

            <div class="mb-3">
                <label for="description" class="form-label">Your Review:</label>
                <InputTextArea id="description" @bind-Value="Review.Description" class="form-control" rows="4" />
                <ValidationMessage For="() => Review.Description" class="text-danger" />
            </div>

            <button type="submit" class="btn btn-primary w-100">Submit Review</button>
        </EditForm>

        <div class="mt-3 text-center">
            <a href="/reviews" class="btn-link">Back to List</a>
        </div>
    </div>
</div>

@code {
    [SupplyParameterFromForm]
    private Review Review { get; set; } = new() { Description = string.Empty };

    // These lists hold the data for our Dropdowns
    private List<Customer> Customers = new();
    private List<Service> Services = new();
    private List<Employee> Employees = new();

    protected override async Task OnInitializedAsync()
    {
        // We need to load the lists from the database so the dropdowns have options
        using var context = DbFactory.CreateDbContext();
        Customers = await context.Customer.ToListAsync();
        Services = await context.Service.ToListAsync();
        Employees = await context.Employee.ToListAsync();
    }

    private async Task AddReview()
    {
        using var context = DbFactory.CreateDbContext();

        // This takes the ID numbers selected in the dropdowns and saves them
        context.Review.Add(Review);
        await context.SaveChangesAsync();

        NavigationManager.NavigateTo("/reviews");
    }
}